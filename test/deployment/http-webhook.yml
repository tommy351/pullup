apiVersion: pullup.dev/v1beta1
kind: HTTPWebhook
metadata:
  name: http-server
spec:
  resourceName: '{{ .webhook.metadata.name }}-{{ .event.suffix }}'
  schema:
    type: object
    properties:
      suffix:
        type: string
  patches:
    - apiVersion: apps/v1
      kind: Deployment
      sourceName: $(HTTP_SERVER_DEPLOYMENT_NAME)
      merge:
        spec:
          selector:
            matchLabels:
              app: '{{ .webhook.metadata.name }}-{{ .event.suffix }}'
          template:
            metadata:
              labels:
                app: '{{ .webhook.metadata.name }}-{{ .event.suffix }}'
            spec:
              containers:
                - name: http-server
                  env:
                    - name: RESOURCE_NAME
                      value: '{{ .webhook.metadata.name }}-{{ .event.suffix }}'
    - apiVersion: v1
      kind: Service
      sourceName: $(HTTP_SERVER_SERVICE_NAME)
      merge:
        spec:
          selector:
            app: '{{ .webhook.metadata.name }}-{{ .event.suffix }}'
